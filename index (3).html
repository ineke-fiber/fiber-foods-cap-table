<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fiber Foods Group ‚Äî KPI Tracker 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f9f9f7;
    --bg2: #ffffff;
    --bg3: #f3f4f0;
    --card: #ffffff;
    --border: #e4e6df;
    --border2: #edeee9;
    --green: #C9D969;
    --green-dark: #8fa01f;
    --green-mid: #b0c23a;
    --green-bg: rgba(201,217,105,0.18);
    --green-border: rgba(201,217,105,0.5);
    --pink: #ECB6C9;
    --pink-dark: #b8537a;
    --pink-bg: rgba(236,182,201,0.18);
    --pink-border: rgba(236,182,201,0.5);
    --text: #1a1c16;
    --text2: #4a4f3a;
    --text3: #8a9070;
    --warn: #b86b20;
    --warn-bg: rgba(184,107,32,0.1);
    --red: #b83030;
    --red-bg: rgba(184,48,48,0.08);
    --blue: #2a5faa;
    --blue-bg: rgba(42,95,170,0.08);
    --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.04);
    --radius: 10px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 13.5px;
    line-height: 1.6;
  }

  /* HEADER */
  .header {
    background: #fff;
    border-bottom: 3px solid var(--green);
    padding: 0 28px;
    display: flex; align-items: center; justify-content: space-between;
    height: 58px;
    position: sticky; top: 0; z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .header-left { display: flex; align-items: center; gap: 13px; }
  .logo-mark {
    width: 34px; height: 34px; border-radius: 8px;
    background: var(--green);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Roboto Condensed', sans-serif;
    font-weight: 700; font-size: 18px; color: #3a4000;
  }
  .header-title {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 20px; font-weight: 700; color: var(--text);
  }
  .header-sub { font-size: 11px; color: var(--text3); }
  .year-badge {
    background: var(--green-bg); border: 1px solid var(--green-border);
    color: var(--green-dark); padding: 3px 12px; border-radius: 20px;
    font-size: 12px; font-weight: 600;
  }

  /* LAYOUT */
  .app-layout { display: flex; min-height: calc(100vh - 58px); }

  /* SIDEBAR */
  .sidebar {
    width: 228px; min-width: 228px;
    background: #fff;
    border-right: 1px solid var(--border2);
    padding: 18px 0;
    position: sticky; top: 58px;
    height: calc(100vh - 58px);
    overflow-y: auto;
  }
  .sidebar-section { margin-bottom: 4px; }
  .sidebar-section-title {
    padding: 8px 16px 3px;
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 10px; font-weight: 700;
    color: var(--text3); letter-spacing: 0.12em; text-transform: uppercase;
  }
  .sidebar-item {
    padding: 7px 16px;
    display: flex; align-items: center; gap: 9px;
    cursor: pointer; transition: all 0.1s;
    color: var(--text2); font-size: 13px;
    border-left: 3px solid transparent;
  }
  .sidebar-item:hover { background: var(--green-bg); color: var(--text); }
  .sidebar-item.active {
    background: var(--green-bg);
    color: var(--green-dark);
    border-left-color: var(--green-dark);
    font-weight: 600;
  }
  .sidebar-avatar {
    width: 24px; height: 24px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; font-weight: 700; flex-shrink: 0;
    font-family: 'Roboto Condensed', sans-serif;
  }
  .sidebar-badge {
    margin-left: auto; font-size: 10px;
    padding: 1px 6px; border-radius: 8px; font-weight: 600;
    background: var(--pink-bg); color: var(--pink-dark);
  }
  .sidebar-badge.ok { background: var(--green-bg); color: var(--green-dark); }
  .sidebar-badge.empty { background: var(--red-bg); color: var(--red); }
  .sidebar-divider { height: 1px; background: var(--border2); margin: 8px 16px; }

  /* MAIN */
  .main { flex: 1; padding: 30px 36px; overflow-y: auto; }

  /* PAGE HEADER */
  .page-header { margin-bottom: 26px; }
  .page-header h1 { font-family: 'Roboto Condensed', sans-serif; font-size: 30px; font-weight: 700; }
  .page-header p { color: var(--text3); margin-top: 3px; font-size: 13px; }

  /* CARDS */
  .card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 22px;
    margin-bottom: 16px; box-shadow: var(--shadow);
  }
  .card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; gap: 12px; }
  .card-title { font-family: 'Roboto Condensed', sans-serif; font-size: 16px; font-weight: 700; color: var(--text); }
  .kpi-number {
    width: 26px; height: 26px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 12px; font-weight: 700; flex-shrink: 0;
    background: var(--green-bg); border: 1.5px solid var(--green-border); color: var(--green-dark);
  }

  /* FORM */
  .form-group { margin-bottom: 13px; }
  .form-label {
    display: block; font-family: 'Roboto Condensed', sans-serif;
    font-size: 10px; font-weight: 700;
    color: var(--text3); text-transform: uppercase; letter-spacing: 0.09em;
    margin-bottom: 5px;
  }
  textarea, input[type="text"], select {
    width: 100%; background: var(--bg3);
    border: 1.5px solid var(--border); border-radius: 7px;
    color: var(--text); padding: 8px 12px;
    font-family: 'Inter', sans-serif; font-size: 13px; line-height: 1.5;
    resize: vertical; outline: none; transition: border-color 0.12s, box-shadow 0.12s;
  }
  textarea:focus, input:focus, select:focus {
    border-color: var(--green-mid); box-shadow: 0 0 0 3px var(--green-bg); background: #fff;
  }
  textarea { min-height: 74px; }
  select option { background: #fff; }

  /* REVIEW PANELS */
  .review-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 11px; margin-top: 16px; }
  .review-panel { background: var(--bg3); border: 1px solid var(--border2); border-radius: 8px; padding: 13px; }
  .review-panel-title {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 10.5px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.09em;
    margin-bottom: 9px;
    display: flex; align-items: center; gap: 5px;
  }
  .dot { width: 7px; height: 7px; border-radius: 50%; }

  /* SCORE */
  .score-row { display: flex; align-items: center; gap: 8px; margin-bottom: 9px; }
  .score-label { font-size: 11px; color: var(--text3); min-width: 40px; }
  .score-btns { display: flex; gap: 3px; }
  .score-btn {
    width: 27px; height: 27px; border-radius: 5px;
    border: 1.5px solid var(--border); background: #fff;
    color: var(--text2); cursor: pointer;
    font-family: 'Roboto Condensed', sans-serif; font-size: 12px; font-weight: 700;
    display: flex; align-items: center; justify-content: center; transition: all 0.1s;
  }
  .score-btn:hover { border-color: var(--green-mid); color: var(--green-dark); }
  .score-btn.selected { background: var(--green); border-color: var(--green-mid); color: #3a4000; }

  /* STATUS BADGE */
  .status-badge {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 10px; padding: 3px 8px; border-radius: 4px;
    font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase;
  }
  .status-on-track { background: var(--green-bg); color: var(--green-dark); border: 1px solid var(--green-border); }
  .status-at-risk { background: var(--warn-bg); color: var(--warn); }
  .status-behind { background: var(--red-bg); color: var(--red); }
  .status-not-started { background: var(--bg3); color: var(--text3); border: 1px solid var(--border); }

  /* BUTTONS */
  .btn {
    padding: 7px 15px; border-radius: 7px;
    font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 500;
    cursor: pointer; border: none; transition: all 0.1s;
    display: inline-flex; align-items: center; gap: 5px;
  }
  .btn-primary { background: var(--green); color: #3a4000; }
  .btn-primary:hover { background: var(--green-mid); }
  .btn-ghost { background: transparent; border: 1.5px solid var(--border); color: var(--text2); }
  .btn-ghost:hover { border-color: var(--green-mid); color: var(--green-dark); }
  .btn-sm { padding: 5px 12px; font-size: 12px; }

  /* TOAST */
  .save-toast {
    position: fixed; bottom: 22px; right: 22px;
    background: var(--text); color: var(--green);
    padding: 10px 18px; border-radius: 8px;
    font-size: 13px; font-weight: 500;
    transform: translateY(60px); opacity: 0;
    transition: all 0.22s; z-index: 999;
    box-shadow: 0 4px 20px rgba(0,0,0,0.18);
  }
  .save-toast.show { transform: translateY(0); opacity: 1; }

  /* STATS */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 13px; margin-bottom: 24px; }
  .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; box-shadow: var(--shadow); }
  .stat-value { font-family: 'Roboto Condensed', sans-serif; font-size: 30px; font-weight: 700; }
  .stat-value.green { color: var(--green-dark); }
  .stat-value.pink { color: var(--pink-dark); }
  .stat-label { font-family: 'Roboto Condensed', sans-serif; font-size: 10.5px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 2px; }
  .stat-bar { height: 3px; background: var(--border2); border-radius: 2px; margin-top: 10px; }
  .stat-bar-fill { height: 100%; border-radius: 2px; }

  /* COMPANY TARGETS */
  .target-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 13px; margin-bottom: 22px; }
  .target-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 18px 20px;
    box-shadow: var(--shadow); border-top: 3px solid var(--green);
  }
  .target-card.pink-top { border-top-color: var(--pink); }
  .target-label { font-family: 'Roboto Condensed', sans-serif; font-size: 10px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 0.09em; margin-bottom: 5px; }
  .target-value-input {
    width: 100%; border: none; background: transparent;
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 24px; font-weight: 700; color: var(--text);
    outline: none; border-bottom: 2px dashed var(--border);
    padding: 0 0 2px; transition: border-color 0.12s;
    display: block; margin-bottom: 4px;
  }
  .target-value-input:focus { border-bottom-color: var(--green-dark); }
  .target-desc { font-size: 11.5px; color: var(--text3); }

  /* TEAM TABLE */
  .team-table { width: 100%; border-collapse: collapse; }
  .team-table th {
    text-align: left; padding: 9px 13px;
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 10.5px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em;
    color: var(--text3); border-bottom: 2px solid var(--border2);
  }
  .team-table td { padding: 10px 13px; border-bottom: 1px solid var(--border2); vertical-align: middle; }
  .team-table tr:hover td { background: var(--green-bg); }
  .team-table tr:last-child td { border-bottom: none; }
  .member-name { font-weight: 600; cursor: pointer; color: var(--green-dark); }
  .member-name:hover { text-decoration: underline; }
  .region-tag {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 9.5px; padding: 2px 7px; border-radius: 3px;
    font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase;
  }
  .region-nl { background: var(--blue-bg); color: var(--blue); }
  .region-ug { background: var(--warn-bg); color: var(--warn); }
  .region-ke { background: var(--green-bg); color: var(--green-dark); }
  .region-uk { background: var(--pink-bg); color: var(--pink-dark); }
  .progress-bar-wrap { width: 80px; height: 5px; background: var(--border2); border-radius: 3px; display: inline-block; vertical-align: middle; }
  .progress-bar-fill { height: 100%; border-radius: 3px; background: var(--green); }

  /* TASKS */
  .task-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px 18px;
    margin-bottom: 11px; display: flex; gap: 18px; align-items: flex-start;
    box-shadow: var(--shadow); border-left: 4px solid var(--border);
  }
  .task-card.assigned { border-left-color: var(--green); }
  .task-num { font-family: 'Roboto Condensed', sans-serif; font-size: 20px; font-weight: 700; color: var(--green-dark); min-width: 22px; padding-top: 1px; }
  .task-content { flex: 1; }
  .task-title-main { font-family: 'Roboto Condensed', sans-serif; font-size: 14px; font-weight: 700; color: var(--text); margin-bottom: 2px; }
  .task-desc { font-size: 12px; color: var(--text2); line-height: 1.5; }
  .task-action { font-size: 11.5px; color: var(--text3); margin-top: 4px; font-style: italic; }
  .task-assign { min-width: 185px; }
  .task-assigned-list { margin-top: 7px; display: flex; flex-wrap: wrap; gap: 5px; }
  .assignee-chip {
    font-size: 11px; padding: 2px 9px; border-radius: 20px;
    background: var(--pink-bg); color: var(--pink-dark);
    border: 1px solid var(--pink-border);
    display: flex; align-items: center; gap: 4px;
  }
  .remove-chip { cursor: pointer; opacity: 0.5; }
  .remove-chip:hover { opacity: 1; }
  .priority-tag {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 9px; padding: 1px 6px; border-radius: 3px;
    font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; margin-left: 6px;
  }
  .prio-high { background: var(--red-bg); color: var(--red); }
  .prio-med { background: var(--warn-bg); color: var(--warn); }

  /* DIVIDER */
  .section-divider { display: flex; align-items: center; gap: 12px; margin: 26px 0 16px; }
  .section-divider-line { flex: 1; height: 1px; background: var(--border); }
  .section-divider-text { font-family: 'Roboto Condensed', sans-serif; font-size: 10.5px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text3); white-space: nowrap; }

  /* SCROLLBAR ‚Äî visible and easy to use */
  .main::-webkit-scrollbar { width: 10px; }
  .main::-webkit-scrollbar-track { background: var(--bg3); border-radius: 5px; }
  .main::-webkit-scrollbar-thumb { background: var(--green); border-radius: 5px; border: 2px solid var(--bg3); }
  .main::-webkit-scrollbar-thumb:hover { background: var(--green-dark); }

  .sidebar::-webkit-scrollbar { width: 5px; }
  .sidebar::-webkit-scrollbar-track { background: transparent; }
  .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .right-sidebar::-webkit-scrollbar { width: 5px; }
  .right-sidebar::-webkit-scrollbar-track { background: transparent; }
  .right-sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Firefox */
  .main { scrollbar-width: auto; scrollbar-color: var(--green) var(--bg3); }


  /* RIGHT SIDEBAR */
  .right-sidebar {
    width: 200px; min-width: 200px;
    background: #fff;
    border-left: 1px solid var(--border2);
    padding: 16px 0 20px;
    position: sticky; top: 58px;
    height: calc(100vh - 58px);
    overflow-y: auto;
    flex-shrink: 0;
  }
  .right-sidebar-header {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 10px; font-weight: 700;
    color: var(--text3); letter-spacing: 0.12em; text-transform: uppercase;
    padding: 0 14px 10px;
    border-bottom: 2px solid var(--green);
    margin-bottom: 8px;
  }
  .right-kpi-item {
    padding: 9px 14px;
    border-bottom: 1px solid var(--border2);
    transition: background 0.1s;
    cursor: default;
  }
  .right-kpi-item:hover { background: var(--green-bg); }
  .right-kpi-label {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 9px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--text3); margin-bottom: 1px;
  }
  .right-kpi-value {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 19px; font-weight: 700; color: var(--text); line-height: 1.15;
  }
  .right-kpi-value.g { color: var(--green-dark); }
  .right-kpi-value.p { color: var(--pink-dark); }
  .right-kpi-desc { font-size: 10px; color: var(--text3); margin-top: 1px; line-height: 1.3; }
  .right-notes-section {
    padding: 10px 14px 0;
    border-top: 1px solid var(--border2);
    margin-top: 4px;
  }
  .right-notes-title {
    font-family: 'Roboto Condensed', sans-serif;
    font-size: 9px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--text3); margin-bottom: 5px;
  }
  .right-notes-text {
    font-size: 11px; color: var(--text2); line-height: 1.55;
    white-space: pre-wrap;
  }
  @media (max-width: 1100px) { .right-sidebar { display: none; } }

  @media (max-width: 768px) {
    .sidebar { display: none; }
    .main { padding: 18px; }
    .review-grid { grid-template-columns: 1fr; }
    .task-card { flex-direction: column; }
    .task-assign { min-width: 100%; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo-mark">F</div>
    <div>
      <div class="header-title">Fiber Foods Group</div>
      <div class="header-sub">KPI Tracker</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px">
    <span class="year-badge">2026</span>
    <button class="btn btn-primary btn-sm" onclick="saveAll()">üíæ Save All</button>
  </div>
</div>

<div class="app-layout">
  <nav class="sidebar" id="sidebar"></nav>
  <main class="main" id="main-content"></main>
  <aside class="right-sidebar" id="right-sidebar"></aside>
</div>

<div class="save-toast" id="save-toast">‚úì Saved</div>

<script>
const TEAM_MEMBERS = [
  { id:'inez',    name:'Inez',    region:'NL', role:'CEO / Commerce' },
  { id:'ineke',   name:'Ineke',   region:'NL', role:'COO / Board' },
  { id:'lot',     name:'Lot',     region:'NL', role:'Sales' },
  { id:'lia',     name:'Lia',     region:'NL', role:'Finance' },
  { id:'diederik',name:'Diederik',region:'NL', role:'CTO / Board' },
  { id:'danique', name:'Danique', region:'NL', role:'R&D / Supply Chain' },
  { id:'anne',    name:'Anne',    region:'NL', role:'Research' },
  { id:'hester',  name:'Hester',  region:'NL', role:'Marketing' },
  { id:'naomi',   name:'Naomi',   region:'UK', role:'Operations' },
  { id:'malou',   name:'Malou',   region:'UG', role:'UG Lead / Grants' },
  { id:'marion',  name:'Marion',  region:'UG', role:'Operations UG' },
  { id:'denis',   name:'Denis',   region:'UG', role:'Production UG / R&D' },
  { id:'isaac',   name:'Isaac',   region:'UG', role:'Data' },
  { id:'emma',    name:'Emma',    region:'UG', role:'Sourcing' },
  { id:'florence',name:'Florence',region:'UG', role:'Sourcing / Projects' },
  { id:'cecilia', name:'Cecilia', region:'KE', role:'Production KE' },
  { id:'yvette',  name:'Yvette',  region:'KE', role:'Quality' },
];

const AVATAR_COLS = ['#8fa01f','#b8537a','#2a5faa','#b86b20','#6a50a0','#2a8f8f','#b83060','#4f8a40'];
function aColor(id) { return AVATAR_COLS[id.split('').reduce((s,c)=>s+c.charCodeAt(0),0)%AVATAR_COLS.length]; }
function ini(n) { return n.slice(0,2).toUpperCase(); }

const TASKS = [
  { id:'t_crm',  num:1, title:'CRM / Sales-Pipeline Data Stewardship', desc:'Ensure Pipedrive data quality and follow-up discipline across the commercial team.', action:'KPI: % deals with complete Pipedrive data / % leads with follow-up within 7 days; monthly data quality review.', prio:'high' },
  { id:'t_kpi',  num:2, title:'KPI Consolidation & Quality (Central KPI Owner / BI)', desc:'Appoint a KPI owner, create a unified SMART template and enable monthly dashboarding.', action:'Appoint KPI owner; uniform SMART template; monthly dashboarding.', prio:'high' },
  { id:'t_hr',   num:3, title:'HR & Contracts (Freelance / Employment Law)', desc:'HR audit: classify all contracts and perform a risk analysis.', action:'KPI: % contracts checked and documented.', prio:'high' },
  { id:'t_qfs',  num:4, title:'Quality, Food Safety & Certification (NL Compliance)', desc:'Ensure all suppliers are certified and the company is recall-ready.', action:'KPI: % suppliers certified / days to recall readiness / audit status.', prio:'high' },
  { id:'t_sup',  num:5, title:'Supplier Development & Procurement Ownership (UG/KE)', desc:'Manage Uganda and Kenya supplier relationships with clear SLAs and quality targets.', action:'KPI: % suppliers with SLA / % on-time deliveries / quality deviations per supplier.', prio:'med' },
  { id:'t_leg',  num:6, title:'Legal / Tax Structuring (Prime Jack / Corporate)', desc:'Complete legal review and implement fiscal plan for PrimeJack¬Æ corporate structure.', action:'KPI: fiscal plan implemented / legal structure finalised.', prio:'med' },
  { id:'t_it',   num:7, title:'IT / Data Governance & Security', desc:'Simple IT audit covering backups, MFA, and incident tracking.', action:'KPI: % systems with backup & MFA / incidents per quarter.', prio:'med' },
  { id:'t_esg',  num:8, title:'Sustainability / ESG / Product-Level Certification', desc:'Build a certification roadmap and establish Scope 1‚Äì3 baseline and targets.', action:'KPI: certification roadmap / Scope 1‚Äì3 baseline and targets set.', prio:'med' },
];

const CT_DEFAULT = [
  { id:'ct_sales',    label:'Sales Target 2026',    def:'‚Ç¨1.3M',   desc:'Total Revenue', pink:false },
  { id:'ct_margin',   label:'General Margin',       def:'35%',      desc:'Gross Margin Target', pink:false },
  { id:'ct_cogs',     label:'COGS',                 def:'‚Ç¨13/kg',   desc:'Cost of Goods Sold per KG', pink:true },
  { id:'ct_asp',      label:'Average Sales Price',  def:'‚Ç¨21/kg',   desc:'Per KG target price', pink:true },
  { id:'ct_ret',      label:'Customer Retention',   def:'80%',      desc:'Annual customer retention rate', pink:false },
  { id:'ct_del',      label:'Deliveries to Spec',   def:'90%',      desc:'Deliveries meeting specifications', pink:false },
  { id:'ct_aud',      label:'Audits per Supplier',  def:'1',        desc:'Minimum annual audits per supplier', pink:true },
  { id:'ct_farm',     label:'Farmers +10% Income',  def:'1,000',    desc:'Farmers earning 10% extra from Jackfruit', pink:true },
];

const CT_OPS = [
  { id:'op_kg_sell',       label:'KG to be Sold',          def:'62,000',        desc:'Total sales volume target 2026', pink:false },
  { id:'op_kg_stock',      label:'Current KG in Stock',    def:'35,000',        desc:'Current available inventory', pink:false },
  { id:'op_kg_from_stock', label:'KG Sold from Stock',     def:'24,500',        desc:'70% of stock to be sold', pink:true },
  { id:'op_kg_produce',    label:'KG to Produce',          def:'37,500',        desc:'Additional production needed', pink:true },
  { id:'op_oyster',        label:'New Value Chain',        def:'1 product market fit', desc:'Oysternut ‚Äî product market fit 2026', pink:false },
];

const DK = {
  inez:[
    {obj:'Win with Retail Suppliers in blended meat & fish ‚Äî 1.2M EUR TO',kpi:'Develop current customers & win new customers in BNLX (20 customers, 800K EUR TO)\nAccelerate winning applications: 5 customers, 400K TO\nOpen German market: 2 customer agreements\nWin orders for Hybrid by push from at least one Retailer (Lidl?)'},
    {obj:'Conquer Foodservice (2A) & Win through partnerships with Ingredient suppliers (2B) ‚Äî 0.2M EUR TO',kpi:'Win with Global accounts locally e.g. IKEA test set in 2027\nWin with Catering companies: HAI deal launched with 100K TO\nPartner on joint blends: 2 launches with joint applications\nPartner through business models: lock 1 partnership'},
    {obj:'Increase efficiency & impact: more customer contacts, leads and deals',kpi:'CRM implementation: Increased efficiency, more customer contact, onboard trainee on sales/marketing\nOnline to Offline: Increased Traffic, Leads and deals closed\nSharpened customer story: Increased hit rate, volumes and profitability'},
    {obj:'Steady group of investors ready for conversion and/or growth',kpi:'From April 2026 schedule meetings with new investors; make target list with Peakbridge'},
    {obj:'Personal Development',kpi:'Laser focus on top 20 prospects; strong leadership and time management on sales and BD'},
  ],
  ineke:[
    {obj:'Win grants',kpi:'Win 580K in grant money\n- Streamline fundraising with Malou and Marion (with AI support)\n- Apply for at least 6 matching grants that support production capacity and/or P&L'},
    {obj:'Guarantee smooth supply chain',kpi:'Efficient and quality process from order to delivery\n- Process is clear and team members are well placed\n- Systems and service providers are in place\n- Maximizing cost reduction to lower cost price'},
    {obj:'Consistent following of financial model',kpi:'- Weekly update to the board\n- Quarterly update to investors\n- Work closely with Lia, Marion, Raymond, Reender towards real-time accurate financial transparency'},
    {obj:'New business development through ingredient innovation',kpi:'- Validate the unique fiber profile of our PJ with research institutes and experts\n- Establish partnerships to explore new markets in collaboration with Inez\n- Further build on the ON value chain in UG, incl. increasing capacity and market development\n- Test 1 product market fit in 2026'},
    {obj:'Personal Development',kpi:'Work smartly together with the team and only do what you need to do\nDo not get dragged into cashflow problems ‚Äî keep track, prevent spending outside budget, involve the board'},
  ],
  lot:[
    {obj:'Win with retail: Launch blended meat in NL',kpi:'Increase TO: Four Seasons, Smilde, Chateau Viande, Koning Vlees\nIntroductions: Gepo Leverworst in 3 chains (AH, Jumbo, Picnic), Westfort burgers in SU, Plukon kipkrokant in Plus, Pieter van Meel 5 product introductions, 2Sisters/Remkes\nNew Developments: Compaxo, Vion, Sopraco (Hybrid range), Denibar\nNew Lead Generation: Analyse full EG list and set correct leads in Pipedrive by April'},
    {obj:'Conquer FS: Launch blended 40% Burgers in FS NL',kpi:'Launch 40% PJ burger at Efteling Q2 / Q4 Port Aventura\nCampaign and rollout to all FS wholesalers (Sligro, Hanos, etc.)\nLaunch and accelerate Zandbergen Hybrid portfolio'},
    {obj:'Commercial Development: Lead Pipedrive',kpi:'- Update and constantly control data quality in Pipedrive\n- Sales flow and data availability: Contacts, Funnel value, forecast'},
    {obj:'Commercial Development: Online to Offline Marketing',kpi:'Create overview of key fairs, who goes where and what comms is needed\nWebsite review\nLinkedIn plan based on fairs and key launches'},
    {obj:'Personal Development',kpi:'Join commercial strategy sessions (e.g. Sue)\nRedesign Food Value program\nPlant FWD presentation'},
  ],
  lia:[
    {obj:'Verwerking Financi√´le Mutaties',kpi:'Minimaal 90% van alle financi√´le mutaties (inkoop/verkoopfacturen, betalingen, bankmutaties) wordt binnen 7 werkdagen na ontstaan volledig en correct verwerkt'},
    {obj:'Tijdige en Correcte Facturatie',kpi:'Minimaal 90% van de verkoopfacturen wordt binnen 3 werkdagen na order/levering correct verzonden en conform het vastgestelde debiteurenproces opgevolgd'},
    {obj:'Kwaliteit en Nauwkeurigheid van de Administratie',kpi:"Het aantal administratieve fouten in de financi√´le administratie dat leidt tot correcties, herboekingen of creditnota's bedraagt maximaal 3 per maand"},
    {obj:'Rapportage en Compliance',kpi:'Maandelijks wordt uiterlijk op de 5e werkdag een volledig en juist financieel overzicht aangeleverd, in overeenstemming met de geldende wet- en regelgeving (o.a. BTW)'},
    {obj:'Persoonlijke Ontwikkeling',kpi:'Onderzoeksvraag: hoe brengen we de Oegandese en Nederlandse administratie het beste bij elkaar (samen met Raymond, Ineke, Reender, Marion)\nNadenken over een persoonlijk ontwikkelingsdoel'},
  ],
  diederik:[
    {obj:'Contribute fully as a board member to drive company growth, make strategic decisions, and strengthen teamwork',kpi:'- Be the driving force for board meetings, make sure they start on time and are structured by 31/03/2026\n- Review structure and output of board meeting quarterly and give feedback for improvement'},
    {obj:'Take full ownership of leading the R&D department, providing clear direction and ensuring projects and priorities are aligned',kpi:'- Implement R&D meetings with the right people and frequency by 28/02/2026\n- Use AI as an R&D colleague to improve accessibility of all documentation by 01/06/2026\n- Build a structure to oversee all R&D activities in NL, UG and KE by 31/03/2026\n- Provide guidance on new S&OP structure by 14/02/2026'},
    {obj:'Develop winning applications by collaborating with customers and optimizing our product portfolio',kpi:'- By 31/12/2026 the Organic portfolio will be expanded to at least 3 available sizes\n- By 31/12/2026 narrow down the portfolio to 5 sizes that best fit customer needs (excl. organic)\n- Develop at least 5 hybrid applications approved by customers by 31/12/2026'},
    {obj:'Optimize the production process ‚Äî cost, technical efficiency, and product quality',kpi:'- By 30/06/2026 determine what machinery needs replacing/adjusting at both facilities; implement new dryers at Enimiro by 31/12/2026\n- Map all production costs from sourcing to DJF by 31/03/2026\n- Review production performance mid year and end of year with KE, UG and NL teams'},
    {obj:'Personal Development: Maintain high engagement and motivation',kpi:'- Quarterly review with both board members assessing role as driving force (rating "good" or higher)\n- Quarterly workload and motivation review with documented self-assessment score (‚â•7/10), concrete actions if score falls below'},
  ],
  danique:[
    {obj:'Coordinate an end-to-end, forecast-driven supply chain from the Netherlands, in close collaboration with NL, KE and UG colleagues',kpi:'1. New way of working with new team implemented by 28/02/2026\n2. Inventory up-to-date in Exact and S&OP form by 28/02/2026\n3. Forecast-driven supply chain implemented by June 2026, reviewed quarterly'},
    {obj:'Expand knowledge and hands-on skills in hybrid meat product development, with primary focus on sausage production',kpi:'1. 2 new sausage applications mastered by 30/06/2026\n2. Pilot trials executed and documented for 4 sausage types by 31/12/2026'},
    {obj:'Implement an AI system within R&D to consolidate all available information on product development, technology, and research',kpi:'1. R&D data structured and accessible for AI-driven analysis by 01/03/2026\n2. AI-generated insights reviewed and reinforced by 01/06/2026\n3. Review quality of AI reports quarterly'},
    {obj:'Identify and test plant-based ingredients complementary to jackfruit to achieve products at least 30% plant-based',kpi:'1. Cowpea flour tested as protein enrichment by 01/03/2026\n2. Test minimum 2 other protein sources for hybrid meat with higher protein content by 31/12/2026\n3. Pilot tests with 4 other plant-based ingredients by 01/06/2026, results documented by 01/07/2026\n4. List of complementary plant-based ingredients updated quarterly'},
    {obj:'Personal Development: Take full ownership of end-to-end supply chain',kpi:'1. Full understanding and mapping of all supply chain steps by 28/02/2026\n2. Personal confidence and comfort in the coordinating role assessed through self-reflection and feedback by June 2026'},
  ],
  anne:[
    {obj:'Transfer the knowledge on cooking and drying into the company',kpi:''},
    {obj:'Understanding the water distribution in jackfruit applications',kpi:'Road map for product development for dried jackfruit powder'},
    {obj:'Prepare 2 publications:\n1: Effects of boiling and drying on jackfruit structure\n2: Application oriented',kpi:''},
    {obj:'Keep exploring possibilities to work together with researchers/team in Uganda',kpi:''},
    {obj:'Personal Development: Find and utilise the connection with the company for own benefit',kpi:''},
  ],
  hester:[
    {obj:'By mid-2026, the PrimeJack¬Æ website functions as a primary B2B conversion and due-diligence tool',kpi:'Website content reviewed and approved bi-annually by commercial and impact leads\nEvidence-backed claims: 100% of impact, sourcing, and scale claims linked to formal evidence (LCA, certifications) by Q2 2026\nBuyer risk coverage: Top 5 buyer risks explicitly addressed on the website by Q2 2026'},
    {obj:'By mid-2026, SEO and SEA shift to a primary source of high-intent B2B leads',kpi:'Structured content readiness: 100% of core commercial pages use structured, AI-readable formats\nQuarterly optimisation cycle: SEO/SEA performance reviewed quarterly with sales'},
    {obj:'By end-2026, LinkedIn functions as a targeted account-based communication channel',kpi:'Authority-led content ratio: ‚â•70% of LinkedIn posts focus on proof, insight, or decision support\nNarrative discipline: 100% of LinkedIn and PR messaging aligned with approved PrimeJack¬Æ narrative\nQuarterly review of LinkedIn and PR performance with sales and management'},
    {obj:'By end-2026, AI is embedded across all key departments as a productivity and decision-support tool',kpi:'Team onboarding: 100% of employees trained on approved AI tools by Q2\nActive usage: ‚â•75% of team members use AI tools weekly\nEfficiency gains: At least 20% time reduction on selected recurring tasks by Q3 2026'},
    {obj:'Personal Development: Focus time on high-impact work, stay ahead of AI developments',kpi:'Focused workdays: ‚â•80% of core work scheduled Monday‚ÄìWednesday\nReserve 2 hours/week for AI learning, tracked in calendar\nEnrolled in at least one food photography course in 2026'},
  ],
};

function emptyKpis(){ return Array.from({length:5},(_,i)=>({obj:i===4?'Personal Development':'',kpi:'',status:'not-started',selfMid:'',reviewMid:'',selfEoy:'',reviewEoy:'',scoreMid:0,scoreEoy:0})); }

let appData={}, taskData={}, ctData={}, currentView='home';

const SB_URL = 'https://ujvmqlmzrlfwbmbexmzy.supabase.co';
const SB_KEY = 'sb_publishable_fMClPZof5XcYfUzDt2v0mg_XrhrfMIY';

async function sbGet(key) {
  const res = await fetch(`${SB_URL}/rest/v1/kpi_data?key=eq.${encodeURIComponent(key)}&select=value`, {
    headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}` }
  });
  const rows = await res.json();
  return rows.length ? rows[0].value : null;
}

async function sbSet(key, value) {
  await fetch(`${SB_URL}/rest/v1/kpi_data`, {
    method: 'POST',
    headers: {
      'apikey': SB_KEY,
      'Authorization': `Bearer ${SB_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates'
    },
    body: JSON.stringify({ key, value, updated_at: new Date().toISOString() })
  });
}

async function loadData(){
  try{ const r=await sbGet('ffkpi3'); if(r) appData=r; }catch(e){}
  try{ const r=await sbGet('fftask3'); if(r) taskData=r; }catch(e){}
  try{ const r=await sbGet('ffct3'); if(r) ctData=r; }catch(e){}
  TEAM_MEMBERS.forEach(m=>{
    if(!appData[m.id]){
      const defs=DK[m.id]||[];
      appData[m.id]={kpis:emptyKpis().map((e,i)=>defs[i]?{...e,obj:defs[i].obj,kpi:defs[i].kpi}:e)};
    }
  });
  TASKS.forEach(t=>{ if(!taskData[t.id]) taskData[t.id]={assignees:[]}; });
  CT_DEFAULT.forEach(t=>{ if(!ctData[t.id]) ctData[t.id]=t.def; });
  CT_OPS.forEach(t=>{ if(!ctData[t.id]) ctData[t.id]=t.def; });
}

async function saveAll(){
  const el=document.getElementById('save-toast');
  el.style.color='var(--green)';
  el.innerHTML='‚è≥ Saving‚Ä¶'; el.classList.add('show');
  try{
    await Promise.all([
      sbSet('ffkpi3', appData),
      sbSet('fftask3', taskData),
      sbSet('ffct3', ctData),
    ]);
    el.innerHTML='‚úì Saved for everyone';
    setTimeout(()=>el.classList.remove('show'),2500);
  }catch(e){
    el.style.color='var(--red)';
    el.innerHTML='‚úó Save failed';
    setTimeout(()=>el.classList.remove('show'),3000);
  }
}
function autosave(){ clearTimeout(window._st); window._st=setTimeout(()=>saveAll(),1500); }

// ---- SIDEBAR ----
function renderSidebar(){
  const sb=document.getElementById('sidebar');
  const regionCfg=[
    {key:'NL',label:'Netherlands'},
    {key:'UK',label:'United Kingdom'},
    {key:'UG',label:'Uganda'},
    {key:'KE',label:'Kenya'},
  ];
  let h=`
    <div class="sidebar-section">
      <div class="sidebar-item ${currentView==='home'?'active':''}" onclick="go('home')">
        <span>üè†</span><span style="font-family:'Roboto Condensed',sans-serif;font-weight:600">Company Targets</span>
      </div>
      <div class="sidebar-item ${currentView==='overview'?'active':''}" onclick="go('overview')">
        <span>üìä</span><span>Team Overview</span>
      </div>
    </div>
    <div class="sidebar-divider"></div>`;
  regionCfg.forEach(({key,label})=>{
    const ms=TEAM_MEMBERS.filter(m=>m.region===key);
    if(!ms.length) return;
    h+=`<div class="sidebar-section"><div class="sidebar-section-title">${label}</div>`;
    ms.forEach(m=>{
      const kpis=appData[m.id]?.kpis||[];
      const done=kpis.filter(k=>k.obj.trim()&&k.kpi.trim()).length;
      const bc=done===5?'ok':done===0?'empty':'';
      h+=`<div class="sidebar-item ${currentView===m.id?'active':''}" onclick="go('${m.id}')">
        <div class="sidebar-avatar" style="background:${aColor(m.id)}22;color:${aColor(m.id)};border:1px solid ${aColor(m.id)}44">${ini(m.name)}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:500">${m.name}</div>
          <div style="font-size:10px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${m.role}</div>
        </div>
        <span class="sidebar-badge ${bc}">${done}/5</span>
      </div>`;
    });
    h+=`</div>`;
  });
  h+=`<div class="sidebar-divider"></div>
    <div class="sidebar-section">
      <div class="sidebar-item ${currentView==='tasks'?'active':''}" onclick="go('tasks')">
        <span>üìã</span><span>Uncovered Tasks</span>
      </div>
    </div>`;
  sb.innerHTML=h;
}

function go(v){
  currentView=v; renderSidebar(); renderRightSidebar();
  if(v==='home') renderHome();
  else if(v==='overview') renderOverview();
  else if(v==='tasks') renderTasks();
  else renderMember(v);
}

// ---- HOME ----
function renderHome(){
  const main=document.getElementById('main-content');
  let h=`<div class="page-header"><h1>Company Targets 2026</h1><p>Business-wide KPIs ‚Äî click any value to edit</p></div><div class="target-grid">`;
  CT_DEFAULT.forEach(t=>{
    const val=ctData[t.id]??t.def;
    h+=`<div class="target-card ${t.pink?'pink-top':''}">
      <div class="target-label">${t.label}</div>
      <input class="target-value-input" value="${esc(val)}" oninput="ctData['${t.id}']=this.value;renderRightSidebar();autosave()">
      <div class="target-desc">${t.desc}</div>
    </div>`;
  });
  h+=`</div>
  <div class="section-divider"><div class="section-divider-line"></div><div class="section-divider-text">Operational KPIs ‚Äî Supply Chain & Production</div><div class="section-divider-line"></div></div>
  <div class="target-grid">`;
  CT_OPS.forEach(t=>{
    const val=ctData[t.id]??t.def;
    h+=`<div class="target-card ${t.pink?'pink-top':''}">
      <div class="target-label">${t.label}</div>
      <input class="target-value-input" value="${esc(val)}" oninput="ctData['${t.id}']=this.value;renderRightSidebar();autosave()">
      <div class="target-desc">${t.desc}</div>
    </div>`;
  });
  h+=`</div>
  <div class="section-divider"><div class="section-divider-line"></div><div class="section-divider-text">Strategy Notes</div><div class="section-divider-line"></div></div>
  <div class="card">
    <div class="form-group" style="margin-bottom:0">
      <label class="form-label">Company Strategy Notes / Context</label>
      <textarea rows="5" placeholder="Add any strategic context, priorities or notes for the full team‚Ä¶" oninput="ctData['__notes']=this.value;renderRightSidebar();autosave()">${esc(ctData['__notes']||'')}</textarea>
    </div>
  </div>`;
  main.innerHTML=h;
}

// ---- OVERVIEW ----
function renderOverview(){
  const main=document.getElementById('main-content');
  let done=0,total=0;
  TEAM_MEMBERS.forEach(m=>(appData[m.id]?.kpis||[]).forEach(k=>{total++;if(k.obj.trim()&&k.kpi.trim())done++;}));
  const ta=TASKS.filter(t=>taskData[t.id]?.assignees?.length>0).length;
  const pct=Math.round(done/total*100);
  let h=`<div class="page-header"><h1>Team Overview</h1><p>2026 ‚Äî All Regions</p></div>
  <div class="stats-grid">
    <div class="stat-card"><div class="stat-value green">${TEAM_MEMBERS.length}</div><div class="stat-label">Team Members</div><div class="stat-bar"><div class="stat-bar-fill" style="width:100%;background:var(--green)"></div></div></div>
    <div class="stat-card"><div class="stat-value green">${done}</div><div class="stat-label">KPIs Defined</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${pct}%;background:var(--green)"></div></div></div>
    <div class="stat-card"><div class="stat-value pink">${total-done}</div><div class="stat-label">KPIs Pending</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${100-pct}%;background:var(--pink)"></div></div></div>
    <div class="stat-card"><div class="stat-value pink">${ta}/${TASKS.length}</div><div class="stat-label">Tasks Assigned</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${Math.round(ta/TASKS.length*100)}%;background:var(--pink)"></div></div></div>
  </div>
  <div class="card"><div class="card-header"><div class="card-title">All Team Members</div></div>
  <table class="team-table"><thead><tr><th>Name</th><th>Role</th><th>Region</th><th>KPIs</th><th>Mid-Year</th><th>Status</th></tr></thead><tbody>`;
  TEAM_MEMBERS.forEach(m=>{
    const kpis=appData[m.id]?.kpis||[];
    const d=kpis.filter(k=>k.obj.trim()&&k.kpi.trim()).length;
    const mid=kpis.filter(k=>k.selfMid||k.reviewMid).length;
    const rc={NL:'region-nl',UG:'region-ug',KE:'region-ke',UK:'region-uk'}[m.region]||'region-nl';
    const p=Math.round(d/5*100);
    h+=`<tr>
      <td><span class="member-name" onclick="go('${m.id}')">${m.name}</span></td>
      <td style="color:var(--text2);font-size:12px">${m.role}</td>
      <td><span class="region-tag ${rc}">${m.region}</span></td>
      <td><span style="display:inline-flex;align-items:center;gap:7px"><span class="progress-bar-wrap"><span class="progress-bar-fill" style="width:${p}%;display:block"></span></span><span style="font-size:11px;color:var(--text3)">${d}/5</span></span></td>
      <td style="font-size:12px;color:var(--text2)">${mid>0?mid+' filled':'‚Äî'}</td>
      <td>${d===5?'<span class="status-badge status-on-track">Ready</span>':'<span class="status-badge status-not-started">Pending</span>'}</td>
    </tr>`;
  });
  h+=`</tbody></table></div>`;
  main.innerHTML=h;
}

// ---- MEMBER ----
function renderMember(id){
  const m=TEAM_MEMBERS.find(x=>x.id===id); if(!m) return;
  const d=appData[id];
  const rc={NL:'region-nl',UG:'region-ug',KE:'region-ke',UK:'region-uk'}[m.region]||'region-nl';
  const rLabel={NL:'Netherlands',UG:'Uganda',KE:'Kenya',UK:'United Kingdom'}[m.region];
  let h=`<div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:10px">
    <div style="display:flex;align-items:center;gap:12px">
      <div style="width:40px;height:40px;border-radius:50%;background:${aColor(id)}20;border:2px solid ${aColor(id)}60;display:flex;align-items:center;justify-content:center;font-family:'Roboto Condensed',sans-serif;font-size:14px;font-weight:700;color:${aColor(id)}">${ini(m.name)}</div>
      <div>
        <h1 style="font-size:26px">${m.name}</h1>
        <div style="display:flex;align-items:center;gap:7px;margin-top:2px">
          <span style="color:var(--text3);font-size:12px">${m.role}</span>
          <span class="region-tag ${rc}">${rLabel}</span>
        </div>
      </div>
    </div>
    <button class="btn btn-primary btn-sm" onclick="saveAll()">üíæ Save</button>
  </div>`;

  for(let i=0;i<5;i++){
    const kpi=d.kpis[i];
    const pers=i===4;
    const lbl=pers?'5 ‚Äî Personal Development':`${i+1} ‚Äî Business Target`;
    const ac=pers?'var(--pink-dark)':'var(--green-dark)';
    const ns=pers?'background:var(--pink-bg);border-color:var(--pink-border);color:var(--pink-dark)':'';
    h+=`<div class="card">
      <div class="card-header">
        <div style="display:flex;align-items:center;gap:9px;flex:1">
          <div class="kpi-number" style="${ns}">${i+1}</div>
          <div class="card-title" style="color:${ac}">${lbl}</div>
        </div>
        <select style="width:126px;padding:4px 9px;font-size:11px" onchange="setField('${id}',${i},'status',this.value)">
          <option value="not-started" ${kpi.status==='not-started'?'selected':''}>Not Started</option>
          <option value="on-track" ${kpi.status==='on-track'?'selected':''}>On Track</option>
          <option value="at-risk" ${kpi.status==='at-risk'?'selected':''}>At Risk</option>
          <option value="behind" ${kpi.status==='behind'?'selected':''}>Behind</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Objective / Goal</label>
        <textarea rows="2" placeholder="Describe the main objective‚Ä¶" oninput="setField('${id}',${i},'obj',this.value)">${esc(kpi.obj)}</textarea>
      </div>
      <div class="form-group" style="margin-bottom:0">
        <label class="form-label">KPI / Success Metrics</label>
        <textarea rows="4" placeholder="Define specific, measurable KPIs and milestones‚Ä¶" oninput="setField('${id}',${i},'kpi',this.value)">${esc(kpi.kpi)}</textarea>
      </div>
      <div class="review-grid">
        <div class="review-panel">
          <div class="review-panel-title" style="color:var(--warn)"><div class="dot" style="background:var(--warn)"></div>Mid-Year Review</div>
          <div class="form-group" style="margin-bottom:7px">
            <label class="form-label" style="font-size:9px">Self Assessment ‚Äî July 2026</label>
            <textarea rows="2" style="font-size:12px" placeholder="How are you tracking?" oninput="setField('${id}',${i},'selfMid',this.value)">${esc(kpi.selfMid)}</textarea>
          </div>
          <div class="score-row"><span class="score-label">Score</span><div class="score-btns">${scoreBtns(id,i,'scoreMid',kpi.scoreMid)}</div></div>
          <div class="form-group" style="margin-bottom:0">
            <label class="form-label" style="font-size:9px">Manager Review ‚Äî July 2026</label>
            <textarea rows="2" style="font-size:12px" placeholder="Manager feedback‚Ä¶" oninput="setField('${id}',${i},'reviewMid',this.value)">${esc(kpi.reviewMid)}</textarea>
          </div>
        </div>
        <div class="review-panel">
          <div class="review-panel-title" style="color:var(--red)"><div class="dot" style="background:var(--red)"></div>End of Year Review</div>
          <div class="form-group" style="margin-bottom:7px">
            <label class="form-label" style="font-size:9px">Self Assessment ‚Äî Dec 2026</label>
            <textarea rows="2" style="font-size:12px" placeholder="Reflect on your results‚Ä¶" oninput="setField('${id}',${i},'selfEoy',this.value)">${esc(kpi.selfEoy)}</textarea>
          </div>
          <div class="score-row"><span class="score-label">Score</span><div class="score-btns">${scoreBtns(id,i,'scoreEoy',kpi.scoreEoy)}</div></div>
          <div class="form-group" style="margin-bottom:0">
            <label class="form-label" style="font-size:9px">Manager Review ‚Äî Dec 2026</label>
            <textarea rows="2" style="font-size:12px" placeholder="Manager feedback‚Ä¶" oninput="setField('${id}',${i},'reviewEoy',this.value)">${esc(kpi.reviewEoy)}</textarea>
          </div>
        </div>
      </div>
    </div>`;
  }
  document.getElementById('main-content').innerHTML=h;
}

function scoreBtns(id,idx,field,cur){
  return Array.from({length:5},(_,i)=>`<button class="score-btn ${cur===i+1?'selected':''}" onclick="setScore('${id}',${idx},'${field}',${i+1})">${i+1}</button>`).join('');
}

// ---- TASKS ----
function renderTasks(){
  const ta=TASKS.filter(t=>taskData[t.id]?.assignees?.length>0).length;
  let h=`<div class="page-header"><h1>Uncovered Tasks 2026</h1><p>Responsibilities not yet covered by individual KPIs. <strong>${ta}/${TASKS.length}</strong> tasks assigned.</p></div>`;
  [{prio:'high',label:'High Priority ‚Äî Address First'},{prio:'med',label:'Medium Priority'}].forEach(({prio,label})=>{
    h+=`<div class="section-divider"><div class="section-divider-line"></div><div class="section-divider-text">${label}</div><div class="section-divider-line"></div></div>`;
    TASKS.filter(t=>t.prio===prio).forEach(task=>{
      const td=taskData[task.id];
      const chips=td.assignees.map(n=>`<span class="assignee-chip">${n} <span class="remove-chip" onclick="rmAssign('${task.id}','${n}')">‚úï</span></span>`).join('');
      const ptag=prio==='high'?`<span class="priority-tag prio-high">High</span>`:`<span class="priority-tag prio-med">Medium</span>`;
      h+=`<div class="task-card ${td.assignees.length?'assigned':''}">
        <div class="task-num">${task.num}</div>
        <div class="task-content">
          <div class="task-title-main">${task.title}${ptag}</div>
          <div class="task-desc">${task.desc}</div>
          <div class="task-action">Action: ${task.action}</div>
          ${chips?`<div class="task-assigned-list">${chips}</div>`:''}
        </div>
        <div class="task-assign">
          <label class="form-label">Assign To</label>
          <select onchange="addAssign('${task.id}',this)">
            <option value="">‚Äî Select member ‚Äî</option>
            ${TEAM_MEMBERS.filter(m=>!td.assignees.includes(m.name)).map(m=>`<option value="${m.name}">${m.name} (${m.region})</option>`).join('')}
          </select>
        </div>
      </div>`;
    });
  });
  document.getElementById('main-content').innerHTML=h;
}

// ---- UPDATERS ----
function setField(id,i,f,v){ appData[id].kpis[i][f]=v; autosave(); }
function setScore(id,i,f,s){
  const kpi=appData[id].kpis[i];
  kpi[f]=(kpi[f]===s)?0:s;
  document.querySelectorAll('.score-btn').forEach(b=>{
    const oc=b.getAttribute('onclick')||'';
    if(oc.includes(`'${id}',${i},'${f}'`)){
      const m=oc.match(/,(\d+)\)$/);
      if(m) b.classList.toggle('selected',parseInt(m[1])===kpi[f]);
    }
  });
  autosave();
}
function addAssign(tid,sel){
  const n=sel.value; if(!n) return;
  if(!taskData[tid].assignees.includes(n)) taskData[tid].assignees.push(n);
  sel.value=''; autosave(); renderTasks();
}
function rmAssign(tid,n){
  taskData[tid].assignees=taskData[tid].assignees.filter(x=>x!==n);
  autosave(); renderTasks();
}
function esc(s){ if(!s)return''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }


// ---- RIGHT SIDEBAR ----
function renderRightSidebar(){
  const el = document.getElementById('right-sidebar');
  if (!el) return;
  const colors = [false, false, true, true, false, false, true, true]; // pink for alternates
  let h = `<div class="right-sidebar-header">üìä Company Targets 2026</div>`;
  CT_DEFAULT.forEach((t, i) => {
    const val = ctData[t.id] ?? t.def;
    const cls = t.pink ? 'p' : 'g';
    h += `<div class="right-kpi-item">
      <div class="right-kpi-label">${t.label}</div>
      <div class="right-kpi-value ${cls}">${esc(val)}</div>
      <div class="right-kpi-desc">${t.desc}</div>
    </div>`;
  });
  h += `<div style="padding:8px 14px 4px;font-family:'Roboto Condensed',sans-serif;font-size:9px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.12em;border-top:1px solid var(--border2);margin-top:4px">‚öôÔ∏è Operations</div>`;
  CT_OPS.forEach(t=>{
    const val=ctData[t.id]??t.def;
    const cls=t.pink?'p':'g';
    h+=`<div class="right-kpi-item">
      <div class="right-kpi-label">${t.label}</div>
      <div class="right-kpi-value ${cls}" style="font-size:15px">${esc(val)}</div>
      <div class="right-kpi-desc">${t.desc}</div>
    </div>`;
  });
  const notes = ctData['__notes'] || '';
  if (notes.trim()) {
    h += `<div class="right-notes-section">
      <div class="right-notes-title">üå± Strategy Note</div>
      <div class="right-notes-text">${esc(notes)}</div>
    </div>`;
  }
  el.innerHTML = h;
}

async function init(){
  document.getElementById('main-content').innerHTML=`
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;gap:16px;color:var(--text3)">
      <div style="font-size:32px">üå±</div>
      <div style="font-family:'Roboto Condensed',sans-serif;font-size:18px;font-weight:700">Loading Fiber Foods KPI Tracker‚Ä¶</div>
      <div style="font-size:13px">Connecting to shared database</div>
    </div>`;
  await loadData();
  renderSidebar();
  renderRightSidebar();
  renderHome();
}
init();
</script>
</body>
</html>
